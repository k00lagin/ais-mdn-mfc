<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<title>Мониторинг развития сети МФЦ</title>
		<link rel="stylesheet" href="css/at.min.css" />
		<script src="js/vue.js"></script>
		<script src="js/vue-router.js"></script>
		<script src="js/vuex.js"></script>
		<link rel="stylesheet" href="css/style.css" />
		<script src="js/at.min.js"></script>
		<script src="js/httpVueLoader.js"></script>
		<script src="js/vue2-filters.min.js"></script>
		<script src="js/xlsx.full.min.js"></script>
	</head>

	<body>
		<script>
			const store = new Vuex.Store({
				state: {
					showFavoritesOnly: false
				},
				mutations: {
					loadShowFavoritesOnly (state) {
						state.showFavoritesOnly = localStorage.getItem("showFavoritesOnly", "false") === "true";
					},
					toggleFavorites (state) {
						localStorage.setItem("showFavoritesOnly", !state.showFavoritesOnly);
						state.showFavoritesOnly = localStorage.getItem("showFavoritesOnly", "false") === "true";
					},
				}
			});
			var commonMethods = {
				methods: {
					fetchData: function(url, object, paramName) {
						fetch(url, {
							credentials: "same-origin",
							headers: {
								"Content-type":
									"application/x-www-form-urlencoded; charset=UTF-8"
							}
						})
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									object[paramName] = data;
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					asyncFetch: async function(options) {
						return new Promise((resolve, reject) => {
							let baseUrl = "https://моидокументы.рф/mfc/ws/";
							let url = baseUrl + options.url;
							fetch(url, {
								credentials: "same-origin",
								headers: {
									"Content-type":
										"application/x-www-form-urlencoded; charset=UTF-8"
								}
							})
								.then(response => {
									if (!response.ok) {
										throw new Error("Network response was not ok");
									}
									response.json().then(function(data) {
										resolve(data);
									});
								})
								.catch(error => {
									reject(new Error(error));
								});
						});
					},
					fetchAndSave: function(url, path) {
						fetch(url, {
							credentials: "same-origin"
						})
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								//console.log(response.arrayBuffer());
								return response.arrayBuffer();
							})
							.then(function(buffer) {
								//fs.writeFile(path, Buffer(new Uint8Array(buffer)));
								fs.writeFile(path, Buffer.from(buffer), function(err) {
									if(err) {
										console.log(err);
									} else {
										console.log("The file was saved!");
									}
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					sendMultiformData: function(url, form, callback) {
						//TODO https://www.npmjs.com/package/form-data
						var formData = new FormData(form);

						fetch(url, {
							credentials: "same-origin",
							method: "POST",
							body: formData
						}).then(response => {
							if (!response.ok) {
								throw new Error("Network response was not ok");
							}
							response.json().then(function(data) {
								if (data.success) {
									app.$Message.success({
										message: "Успех!",
										duration: 3000
									});
								} else {
									app.$Message.error({
										message: data.data[0],
										duration: 9000
									});
								}
								if (callback != undefined) {
									callback();
								}
							});
						});
					}
				}
			};
			//var PartialMatchFilterComponent = require('PartialMatchFilterComponent');
			//страничка со всеми МФЦ https://моидокументы.рф/mfc/ws/cards/urm/getListWithProjection?query={%22common_data.status%22%3A%22%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B8%D0%B9%22%2C%22common_data.rf_subject%22%3A80}&projection=common_data&page=1&start=0&limit=20
			// инфа о конкретном МФЦ https://моидокументы.рф/mfc/ws/card/amm_sys_urm_card_form/common_data?_dc=1507099217843&id=10673
		</script>
		<script type="text/x-template" id="user-settings">
			<div>
				<div v-for="field in userSettings">
					<label :for="field.field">{{ field.label + ' ' + currentUser[field.field] }}</label><br>
				</div>
			</div>
		</script>
		<div id="app">
			<header v-if="currentUser">
				<div class="spacer"></div>
				<template>
					<router-link to="/user_settings" class="userfio textBtn"
						>{{ currentUser.fio }}</router-link
					>
					<a
						@click.prevent="logout"
						class="logout textBtn"
						href="https://моидокументы.рф/mfc/ws/auth/logout"
						>Выход</a
					>
				</template>
			</header>
			<div v-if="currentUser" class="main">
				<div class="menu">
					<at-menu mode="vertical" router="router">
						<!-- <at-menu-item-group title=""> -->
							<at-menu-item to="/mou_template_list">Шаблоны</at-menu-item>
							<!-- <at-menu-item to="/urm_template_list">ТОСП</at-menu-item> -->
							<!-- <at-menu-item to="/fill_templates">Заполнение</at-menu-item> -->
						</at-menu-item-group>
						<!-- <at-menu-item-group title=""> -->
							<at-menu-item to="/mou_common_data">Подсистемы сбора информации</at-menu-item>
							<!-- <at-menu-item to="/urm_common_data">ТОСП</at-menu-item> -->
						</at-menu-item-group>
					</at-menu>
					<span class="version">v:{{ version }}</span>
				</div>
				<router-view
					class="display"
					style="overflow-y: auto; overflow-x: hidden;"
				></router-view>
			</div>
			<login v-else @auth="updateLogin"></login>
		</div>
		<script>
			const routes = [
				{
					path: "/mou_template_list",
					component: httpVueLoader("vue/mfc-list.vue"),
					props: { list: "mouList", columns: "templateListColumns" }
				},
				// {
				// 	path: "/urm_template_list",
				// 	component: httpVueLoader("vue/mfc-list.vue"),
				// 	props: { list: "urmList", columns: "templateListColumns" }
				// },
				{
					path: "/fill_templates",
					component: httpVueLoader("vue/fill-templates.vue")
				},
				{
					path: "/mou_common_data",
					component: httpVueLoader("vue/mfc-list.vue"),
					props: { list: "mouList", columns: "commonDataColumns" }
				},
				// {
				// 	path: "/urm_common_data",
				// 	component: httpVueLoader("vue/mfc-list.vue"),
				// 	props: { list: "urmList", columns: "commonDataColumns" }
				// },
				{
					path: "/user_settings",
					component: httpVueLoader("vue/user-settings.vue")
				},
				{
					path: "/quarter_data_import/:mouType/:mouId/:year/:month",
					component: httpVueLoader("vue/quarter-data-import-template.vue")
				},
				{
					path: "/common_data/:mouType/:mouId",
					component: httpVueLoader("vue/common-data.vue")
				}
			];
			const router = new VueRouter({
				routes
			});
			Vue.filter("date", function(value) {
				if (!value) return "";
				value = value.toString();
				value.split("-")[0];
				return (
					value.split("-")[2] +
					"." +
					value.split("-")[1] +
					"." +
					value.split("-")[0]
				);
			});
			Vue.filter("datetime", function(value) {
				if (!value) return "";
				value = value.toString();
				let date = value.split("T")[0];
				let time = value.split("T")[1];
				value.split("-")[0];
				return (
					date.split("-")[2] +
					"." +
					date.split("-")[1] +
					"." +
					date.split("-")[0] +
					" " +
					time
				);
			});
			let { app } = require('electron').remote;
			const electronApp = app;
			const { dialog } = require('electron').remote;
			const fs = require("fs");
			app = new Vue({
				router,
				store,
				el: "#app",
				data: {
					currentUser: null,
					currentPage: null,
					cardData: null,
					mfcList: null,
					urmList: null,
					mouList: null,
					gridColumns: null,
					dictionarySubjectName: null,
					searchQuery: "",

					commonDataColumns: [
						{
							label: " ",
							field: "is_favorite",
							noSort: true
						},
						{
							label: "Название",
							field: "full_name"
						},
						{
							label: "Адрес",
							field: "address"
						},
						{
							label: "Дата открытия",
							field: "start_date"
						},
						{
							label: "Окна",
							field: "wnd_count"
						},
					],
					templateListColumns: [
						{
							label: " ",
							field: "is_favorite",
							noSort: true
						},
						{
							label: "Название",
							field: "full_name"
						},
						{
							label: "Адрес",
							field: "address"
						},
						{
							label: "Шаблоны",
							field: "id",
							noSort: true
						},

					],
					userSettings: [
						{
							label: "Логин:",
							field: "email"
						},
						{
							label: "ФИО:",
							field: "fio"
						},
						{
							label: "Роль:",
							field: "roles"
						},
						{
							label: "Субъект:",
							field: "rfSubjectRoleIds"
						}
					]
				},
				computed: {
					// build https://api.github.com/repos/k00lagin/ais-mdn-mfc/commits
					version: function() {
						return electronApp.getVersion();
					},
					favoriteList: {
						get: function() {
							return JSON.parse(localStorage.getItem("favoriteList") || "{}");
						},
						set: function(newValue) {
							localStorage.setItem("favoriteList", JSON.stringify(newValue));
						}
					}
				},
				mounted: function() {
					// this.$store.commit('loadShowFavoritesOnly');
					store.commit('loadShowFavoritesOnly');
				},
				methods: {
					login: function(username, password) {
						fetch("https://моидокументы.рф/mfc/ws/auth/login", {
							credentials: "same-origin",
							method: "post",
							headers: {
								"Content-type":
									"application/x-www-form-urlencoded; charset=UTF-8"
							},
							body: "username=" + username + "&password=" + password
						})
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									app.updateLogin();
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					updateLogin: function() {
						fetch("https://моидокументы.рф/mfc/ws/auth/current", {
							credentials: "same-origin"
						})
							.then(response => {
								if (!response.ok) {
									if (localStorage.rememberLogin == "true") {
										app.login(localStorage.username, localStorage.password);
									}
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									app.currentUser = data;
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					submitLogin: function() {
						var username = document.querySelector("#username").value;
						var password = document.querySelector("#password").value;
						var rememberLogin = document.querySelector("#rememberLogin")
							.checked;
						if (rememberLogin) {
							localStorage.setItem("rememberLogin", rememberLogin);
							localStorage.setItem("username", username);
							localStorage.setItem("password", password);
						} else {
							//localStorage.clear();
							localStorage.removeItem("rememberLogin");
							localStorage.removeItem("username");
							localStorage.removeItem("password");
						}
						app.login(username, password);
					},
					logout: function() {
						//localStorage.clear();
						localStorage.removeItem("rememberLogin");
						localStorage.removeItem("username");
						localStorage.removeItem("password");
						fetch("https://моидокументы.рф/mfc/ws/auth/logout", {
							credentials: "same-origin"
						})
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									app.currentUser = false;
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					getUrmList: function() {
						var newUrmList = null;
						fetch(
							'https://моидокументы.рф/mfc/ws/dictionary/unicombo/?collection=amm_sys_urm_card_form&fields=["_id","common_data.address","common_data.full_name","common_data.status","common_data.profile","common_data.wnd_count","common_data.start_date","common_data.finish_date"]&additionalFilter={"common_data.rf_subject":80,"common_data.status":"\u0434\u0435\u0439\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u0439","$or":[{"common_data.hidden":{"$exists":false}},{"common_data.hidden":{"$in":[0,false]}}]}&sort={"common_data.address":1}&page=1&start=0',
							{
								credentials: "same-origin"
							}
						)
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									newUrmList = [];
									data.items.forEach(function(item, i, arr) {
										newUrmList[i] = item.common_data;
										newUrmList[i].is_favorite =
											app.favoriteList && app.favoriteList[item._id] == true;
										newUrmList[i].id = item._id;
										newUrmList[i].mouType = "urm";
										if (
											newUrmList[i].address.split(",")[1] ===
											" обл. Челябинская"
										) {
											newUrmList[i].shortAddress = newUrmList[i].address
												.split(",")
												.slice(2)
												.join(",");
										}
										if (
											newUrmList[i].full_name.indexOf(
												"Челябинская область "
											) === 0
										) {
											newUrmList[i].shortName = newUrmList[i].full_name
												.substr(20)
												.split(" муниципального района ")
												.join(" района ");
										}
									});
									app.urmList = newUrmList;
									app.mouList = [...(app.mfcList || []), ...newUrmList];
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					getMfcList: function() {
						var newMfcList = null;
						fetch(
							'https://моидокументы.рф/mfc/ws/dictionary/unicombo/?collection=amm_sys_mfc_card_form&fields=["_id","common_data.address","common_data.full_name","common_data.status","common_data.profile","common_data.wnd_count","common_data.start_date","common_data.finish_date"]&additionalFilter={"common_data.rf_subject":80,"common_data.status":"\u0434\u0435\u0439\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u0439","$or":[{"common_data.hidden":{"$exists":false}},{"common_data.hidden":{"$in":[0,false]}}]}&sort={"common_data.address":1}&page=1&start=0',
							{
								credentials: "same-origin"
							}
						)
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									newMfcList = [];
									data.items.forEach(function(item, i, arr) {
										newMfcList[i] = item.common_data;
										newMfcList[i].is_favorite =
											app.favoriteList && app.favoriteList[item._id] == true;
										newMfcList[i].id = item._id;
										newMfcList[i].mouType = "mfc";
										if (
											newMfcList[i].address.split(",")[1] ===
											" обл. Челябинская"
										) {
											newMfcList[i].shortAddress = newMfcList[i].address
												.split(",")
												.slice(2)
												.join(",");
										}
										if (
											newMfcList[i].full_name.indexOf(
												"Челябинской области"
											) >= 0
										) {
											newMfcList[i].shortName = newMfcList[i].full_name
												.replace(' Челябинской области МФЦ', '')
												.replace(' Челябинской области "МФЦ"', '')
												.replace(" муниципального района", " района")
												.replace(newMfcList[i].full_name.match(/[А-Я][А-Я]?([А-Я])/)[0], newMfcList[i].full_name.match(/[А-Я][А-Я]?([А-Я])/)[0] + " МФЦ");
										}
									});
									app.mfcList = newMfcList;
									app.mouList = [...newMfcList, ...(app.urmList || [])];
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					getDictionarySubjectName: function() {
						fetch(
							"https://моидокументы.рф/mfc/ws/dictionary/dictionary_division_population/list/filter",
							{
								credentials: "same-origin",
								method: "post",
								headers: {
									"Content-type": "application/json;charset=UTF-8"
								},
								body: '{disableAccessCheck: true, fields:["rf_subject_name"]}'
							}
						)
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									var dictionarySubjectName = {};
									data.map(function(item) {
										dictionarySubjectName[item._id] = item.rf_subject_name;
									});
									app.dictionarySubjectName = dictionarySubjectName;
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					getMfcCard: function(id) {
						app.cardData = null;
						fetch("https://моидокументы.рф/mfc/ws/cards/mfc/getSingle/" + id, {
							credentials: "same-origin"
						})
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									app.cardData = data;
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					},
					getUrmCard: function(id) {
						app.cardData = null;
						fetch("https://моидокументы.рф/mfc/ws/cards/urm/getSingle/" + id, {
							credentials: "same-origin"
						})
							.then(response => {
								if (!response.ok) {
									throw new Error("Network response was not ok");
								}
								response.json().then(function(data) {
									app.cardData = data;
								});
							})
							.catch(error => {
								throw new Error(error);
							});
					}
				},
				mixins: [commonMethods],
				created: function() {
					this.updateLogin();
					this.getDictionarySubjectName();
					updateInterval = window.setInterval("app.updateLogin()", 300000);
				},
				components: {
					login: httpVueLoader("vue/login.vue")
				}
			});
		</script>
	</body>
</html>
